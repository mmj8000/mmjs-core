"use strict";const M=require("./parse.cjs"),y=require("node:path"),e=require("./utils.cjs"),j=require("node:fs"),_=require("./proxy.cjs"),s=require("./options.cjs"),H=require("./ndos.cjs"),C=a=>(Object.assign(s.serverConfig,s._initServerConfig,a??{}),s.updateLogLevelState(),{name:"vite:mmjs:mock",apply:"serve",enforce:"post",config(n,c){const{scan:u,mockDir:l}=s.serverConfig;if(u&&c.command==="serve")return{server:{watch:{ignored:[`**/${l}/**`]}}}},configureServer(n){const{scan:c,watchDynamicFile:u,apiPrefix:l,mockDir:m}=s.serverConfig,w=n.config.root;s.serverConfig.root=w;const E=y.join(n.config.root,"package.json"),k=JSON.parse(j.readFileSync(E,"utf-8"));if(s.serverConfig._esm=k.type==="module",c)return e.logger.info("‚è≥ Scan Watching..."),_.useProxyRes(n);const o=y.join(w,m);if(u){n.watcher.off(m,d);const i=n.watcher.add(o);i.on("add",d),i.on("unlink",d),i.on("unlinkDir",d)}d();async function d(){try{const i=await H.enhancedFindFiles(o,{recursive:!0,exclude:/node_modules|\.git/});C.__dyMatchPaths=i}catch(i){e.logger.error(i)}}let f=[];if(Array.isArray(l))f.push(...l);else if(l)f.push(l);else{e.logger.error("API Prefix Non-standard");return}f.forEach(i=>{n.middlewares.use(i,N)})}});C.__dyMatchPaths=[];async function N(a,n,c){var f,i;const{root:u,forceMock:l,mockDir:m,timeout:w,downloadExtensions:E,allowOrigin:k}=s.serverConfig;let o="",d="";try{let r=function(t,h=e.getContentTypeByPath(o)){if(n.writableEnded)return e.logger.success(`‚úÖ Mock Successify ${e.colorize(o,"underline")}`);try{h&&n.setHeader("Content-Type",h),setTimeout(()=>{n.end(JSON.stringify(t)),e.logger.success(`‚úÖ Mock Successify ${e.colorize(o,"underline")}`)},w)}catch(g){e.logger.error(g)}};if(a.headers.referer&&(d=new URL((f=a.headers)==null?void 0:f.referer).searchParams.get("remote")??""),d!=="mock"&&!l)return e.logger.info("üîí Browser URL not found mcok Keyword"),c();const x=a.headers[e.getHeaderMimeTypeKey(a)],{encoding:P,fileExt:v}=e.useContentType(x),F=((i=a._parsedUrl)==null?void 0:i.pathname)??"";a.headers["x-custom-request-header"]="vite-plugin-mmjs-mock",n.setHeader("x-custom-response-header","vite-plugin-mmjs-mock"),n.setHeader("Access-Control-Allow-Origin",k),n.setHeader("Access-Control-Allow-Headers",k),o=y.join(u,m,F+v);let p;if(!s.allowExt.includes(v)){const t=j.createReadStream(o),h=e.getContentTypeByPath(o);if(n.setHeader("Content-Type",h||"application/octet-stream"),E.includes(v)){const g=y.basename(o);n.setHeader("Content-Disposition",`attachment; filename="${g}"`),n.setHeader("download-filename",g)}t.pipe(n),t.on("error",g=>{e.logger.error(g),t.destroy(),c()}),t.on("end",()=>{e.logger.success(`‚úÖ ReadStream End ${e.colorize(o,"underline")}`)}),t.on("close",()=>{t.destroyed||t.destroy()});return}if(!e.fileExists(o)){const t=y.join(u,m,F);o=e.findMatchingTemplatePath(C.__dyMatchPaths,t)||o}if(o.endsWith(".json"))try{const t=j.readFileSync(o,{encoding:P});return r(JSON.parse(t))}catch(t){return e.logger.wran(`${t}; ${o}`),c()}if(p=await e.dynamicImport(o),!(p!=null&&p.enabled))throw new Error(s.mockNoEnabledStr);M.useParseQueryParams(a),M.useParseBody(a),_.useResponseAppend(n);let S=p.mock(a,n);S instanceof Promise&&(S=await S),r(S,"application/json")}catch(r){(r==null?void 0:r.message.indexOf(s.mockNoEnabledStr))!==-1?e.logger.info(`üîí Mock Not Enabled! ${e.colorize(o,"underline")}`):s.notFileErrMsg.some(x=>{var P;return((P=r==null?void 0:r.message)==null?void 0:P.indexOf(x))!==-1})?e.logger.wran(`‚ùå File Not Found! ${e.colorize(o,"underline")}`):console.error(e.uniBeforeStrLog(),(r==null?void 0:r.message)||r,e.colorize(o,"underline")),c()}}module.exports=C;
