"use strict";const _=require("./parse.cjs"),y=require("node:path"),e=require("./utils.cjs"),F=require("node:fs"),j=require("./proxy.cjs"),s=require("./options.cjs"),H=require("./ndos.cjs"),C=a=>(Object.assign(s.serverConfig,s._initServerConfig,a??{}),s.updateLogLevelState(),{name:"vite:http:mock",apply:"serve",enforce:"post",config(t,c){const{scan:u,mockDir:l}=s.serverConfig;if(u&&c.command==="serve")return{server:{watch:{ignored:[`**/${l}/**`]}}}},configureServer(t){const{scan:c,watchDynamicFile:u,apiPrefix:l,mockDir:m}=s.serverConfig,w=t.config.root;s.serverConfig.root=w;const E=y.join(t.config.root,"package.json"),k=JSON.parse(F.readFileSync(E,"utf-8"));if(s.serverConfig._esm=k.type==="module",c)return e.logger.info("‚è≥ Scan Watching..."),j.useProxyRes(t);const o=y.join(w,m);if(u){t.watcher.off(m,d);const i=t.watcher.add(o);i.on("add",d),i.on("unlink",d),i.on("unlinkDir",d)}d();async function d(){try{const i=await H.enhancedFindFiles(o,{recursive:!0,exclude:/node_modules|\.git/});C.__dyMatchPaths=i}catch(i){e.logger.error(i)}}let f=[];if(Array.isArray(l))f.push(...l);else if(l)f.push(l);else{e.logger.error("API Prefix Non-standard");return}f.forEach(i=>{t.middlewares.use(i,N)})}});C.__dyMatchPaths=[];async function N(a,t,c){var f,i;const{root:u,forceMock:l,mockDir:m,timeout:w,downloadExtensions:E,allowOrigin:k}=s.serverConfig;let o="",d="";try{let r=function(n,h=e.getContentTypeByPath(o)){if(t.writableEnded)return e.logger.success(`‚úÖ Mock Successify ${e.colorize(o,"underline")}`);try{h&&t.setHeader("Content-Type",h),setTimeout(()=>{t.end(JSON.stringify(n)),e.logger.success(`‚úÖ Mock Successify ${e.colorize(o,"underline")}`)},w)}catch(g){e.logger.error(g)}};if(a.headers.referer&&(d=new URL((f=a.headers)==null?void 0:f.referer).searchParams.get("remote")??""),d!=="mock"&&!l)return e.logger.info("üîí Browser URL not found mcok Keyword"),c();const x=a.headers[e.getHeaderMimeTypeKey(a)],{encoding:P,fileExt:v}=e.useContentType(x),M=((i=a._parsedUrl)==null?void 0:i.pathname)??"";a.headers["x-custom-request-header"]="vite-plugin-mmjs-mock",t.setHeader("x-custom-response-header","vite-plugin-mmjs-mock"),t.setHeader("Access-Control-Allow-Origin",k),t.setHeader("Access-Control-Allow-Headers",k),o=y.join(u,m,M+v);let p;if(!s.allowExt.includes(v)){const n=F.createReadStream(o),h=e.getContentTypeByPath(o);if(t.setHeader("Content-Type",h||"application/octet-stream"),E.includes(v)){const g=y.basename(o);t.setHeader("Content-Disposition",`attachment; filename="${g}"`),t.setHeader("download-filename",g)}n.pipe(t),n.on("error",g=>{e.logger.error(g),n.destroy(),c()}),n.on("end",()=>{e.logger.success(`‚úÖ ReadStream End ${e.colorize(o,"underline")}`)}),n.on("close",()=>{n.destroyed||n.destroy()});return}if(!e.fileExists(o)){const n=y.join(u,m,M);o=e.findMatchingTemplatePath(C.__dyMatchPaths,n)||o}if(o.endsWith(".json"))try{const n=F.readFileSync(o,{encoding:P});return r(JSON.parse(n))}catch(n){return e.logger.wran(`${n}; ${o}`),c()}if(p=await e.dynamicImport(o),!(p!=null&&p.enabled))throw new Error(s.mockNoEnabledStr);_.useParseQueryParams(a),_.useParseBody(a),j.useResponseAppend(t);let S=p.mock(a,t);S instanceof Promise&&(S=await S),r(S,"application/json")}catch(r){(r==null?void 0:r.message.indexOf(s.mockNoEnabledStr))!==-1?e.logger.info(`üîí Mock Not Enabled! ${e.colorize(o,"underline")}`):s.notFileErrMsg.some(x=>{var P;return((P=r==null?void 0:r.message)==null?void 0:P.indexOf(x))!==-1})?e.logger.wran(`‚ùå File Not Found! ${e.colorize(o,"underline")}`):console.error(e.uniBeforeStrLog(),(r==null?void 0:r.message)||r,e.colorize(o,"underline")),c()}}module.exports=C;
