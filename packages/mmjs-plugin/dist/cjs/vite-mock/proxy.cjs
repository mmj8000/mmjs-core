"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const r=require("./utils.cjs"),m=require("./options.cjs"),j=require("node:path"),E=require("./parse.cjs"),D=require("node:fs"),u=require("node:zlib"),z=require("node:stream");function I(t){var l;const a=((l=t.config.server)==null?void 0:l.proxy)??{},{allowOrigin:o}=m.serverConfig;for(let g in a)try{const c=a[g];if(typeof c!="object")continue;const b=c.configure;c.configure=(w,h)=>{w.on("proxyRes",(i,S,U)=>{var C;typeof b=="function"&&b(w,h);const k=j.join(r.safeUrlToFilename(h.target??""),((C=S._parsedUrl)==null?void 0:C.pathname)??"");i.headers["Access-Control-Allow-Origin"]=o.join(","),i.headers["Access-Control-Allow-Headers"]=o.join(",");const q=i.headers["content-encoding"];if(k){const A=i.headers["content-type"],{encoding:p,isInnerTempType:B,mimeType:P,fileExt:v}=r.useContentType(A),f=j.join(t.config.root,m.serverConfig.mockDir,m.serverConfig.scanOutput,k+v);if(B){const d=[];i.on("data",s=>{d.push(s)}),i.on("end",async()=>{var T;let s="";const e=Buffer.concat(d);let n=e;try{switch(q){case"gzip":n=await y(u.gunzip,e);break;case"deflate":n=await y(u.inflate,e);break;case"br":n=await y(u.brotliDecompress,e);break}s=n.toString(p)}catch(_){s=e.toString(p),r.logger.error("解压失败"+_)}const O=await E.transformInnerCodeTempate(s,P,{query:((T=S._parsedUrl)==null?void 0:T.query)??null,filePath:f});r.writeMockFile(f,O,{encoding:p})})}else{let d=function(){r.logger.success(`✅ writeStream End ${r.colorize(f,"underline")}`)};r.existsSyncByMkdir(f);const s=D.createWriteStream(f);let e=null;switch(q){case"gzip":e=u.createGunzip();break;case"deflate":e=u.createInflate();break;case"br":e=u.createBrotliDecompress();break}e?z.pipeline(i,e,s,n=>{if(n)return r.logger.error("写入文件失败:"+n.message);d()}):z.pipeline(i,s,n=>{if(n)return r.logger.error("写入文件失败:"+n.message);d()})}}})}}catch(c){r.logger.error(c)}}function M(t){Reflect.set(t,"send",function(...a){if(!t.writableEnded){const[o,...l]=a;return t.end(typeof o!="function"?JSON.stringify(o):o,...l),t}return t})}function y(t,a){return new Promise((o,l)=>{t(a,(g,c)=>{g?l(g):o(c)})})}exports.useProxyRes=I;exports.useResponseAppend=M;
