"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const r=require("./utils.cjs"),T=require("./options.cjs"),z=require("node:path"),D=require("./parse.cjs"),I=require("node:fs"),u=require("node:zlib"),B=require("node:stream");function M(t){var o;const c=((o=t.config.server)==null?void 0:o.proxy)??{};for(let l in c)try{const i=c[l];if(typeof i!="object")continue;const d=i.configure;i.configure=(y,b)=>{y.on("proxyRes",(a,S,U)=>{var k;typeof d=="function"&&d(y,b);const h=z.join(r.safeUrlToFilename(b.target??""),((k=S._parsedUrl)==null?void 0:k.pathname)??""),w=a.headers["content-encoding"];if(h){const P=a.headers["content-type"],{encoding:g,isInnerTempType:C,mimeType:_,fileExt:j}=r.useContentType(P),f=z.join(t.config.root,T.serverConfig.mockDir,T.serverConfig.scanOutput,h+j);if(C){const p=[];a.on("data",s=>{p.push(s)}),a.on("end",async()=>{var q;let s="";const e=Buffer.concat(p);let n=e;try{switch(w){case"gzip":n=await m(u.gunzip,e);break;case"deflate":n=await m(u.inflate,e);break;case"br":n=await m(u.brotliDecompress,e);break}s=n.toString(g)}catch(E){s=e.toString(g),r.logger.error("解压失败"+E)}const v=await D.transformInnerCodeTempate(s,_,{query:((q=S._parsedUrl)==null?void 0:q.query)??null,filePath:f});r.writeMockFile(f,v,{encoding:g})})}else{let p=function(){r.logger.success(`✅ writeStream End ${r.colorize(f,"underline")}`)};r.existsSyncByMkdir(f);const s=I.createWriteStream(f);let e=null;switch(w){case"gzip":e=u.createGunzip();break;case"deflate":e=u.createInflate();break;case"br":e=u.createBrotliDecompress();break}e?B.pipeline(a,e,s,n=>{if(n)return r.logger.error("写入文件失败:"+n.message);p()}):B.pipeline(a,s,n=>{if(n)return r.logger.error("写入文件失败:"+n.message);p()})}}})}}catch(i){r.logger.error(i)}}function O(t){Reflect.set(t,"send",function(...c){if(!t.writableEnded){const[o,...l]=c;return t.end(typeof o!="function"?JSON.stringify(o):o,...l),t}return t})}function m(t,c){return new Promise((o,l)=>{t(c,(i,d)=>{i?l(i):o(d)})})}exports.useProxyRes=M;exports.useResponseAppend=O;
