"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const t=require("./utils.cjs"),h=require("./options.cjs"),T=require("node:path"),v=require("./parse.cjs"),C=require("node:fs");function B(n){var o;const u=((o=n.config.server)==null?void 0:o.proxy)??{};for(let a in u)try{const s=u[a];if(typeof s!="object")continue;const f=s.configure;s.configure=(d,l)=>{d.on("proxyRes",(i,y,M)=>{var g;typeof f=="function"&&f(d,l);const p=T.join(t.safeUrlToFilename(l.target??""),((g=y._parsedUrl)==null?void 0:g.pathname)??"");if(p){const b=i.headers["content-type"],{encoding:m,isInnerTempType:w,mimeType:q,fileExt:k}=t.useContentType(b),c=T.join(n.config.root,h.serverConfig.mockDir,h.serverConfig.scanOutput,p+k);if(w){const e=[];i.on("data",r=>{e.push(r)}),i.on("end",async()=>{var S;const P=Buffer.concat(e).toString(m),j=await v.transformInnerCodeTempate(P,q,{query:((S=y._parsedUrl)==null?void 0:S.query)??null,filePath:c});t.writeMockFile(c,j,{encoding:m})})}else{t.existsSyncByMkdir(c);const e=C.createWriteStream(c);e.on("error",r=>{t.logger.error(r),e.destroy()}),e.on("close",()=>{t.logger.success(`âœ… writeStream End ${t.colorize(c,"underline")}`),e.destroyed||e.destroy()}),i.on("data",r=>{e.write(r)}),i.on("end",()=>{e.end()})}}})}}catch(s){t.logger.error(s)}}function E(n){Reflect.set(n,"send",function(...u){if(!n.writableEnded){const[o,...a]=u;return n.end(typeof o!="function"?JSON.stringify(o):o,...a),n}return n})}exports.useProxyRes=B;exports.useResponseAppend=E;
