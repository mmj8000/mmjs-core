"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const s=require("./utils.cjs"),e=require("./options.cjs"),w=require("node:path"),b=require("mime-types"),S=require("./parse.cjs");function O(i){var a;const c=((a=i.config.server)==null?void 0:a.proxy)??{};for(let q in c)try{const t=c[q];if(typeof t!="object")continue;const f=t.configure;t.configure=(l,u)=>{l.on("proxyRes",(g,P,j)=>{var y;typeof f=="function"&&f(l,u);const p=w.join(s.safeUrlToFilename(u.target??""),((y=P._parsedUrl)==null?void 0:y.pathname)??"");if(p){const m=[];g.on("data",r=>{m.push(r)}),g.on("end",()=>{var T;const r=Buffer.concat(m),d=j.getHeaders()["content-type"];let n=b.charset(d)||e.allowCharset[0];n=n.toLocaleLowerCase();const o=b.extension(d)||e.serverConfig.fileExt.slice(1),h=(T=e.serverConfig._templateMimeType)!=null&&T.length?e.serverConfig._templateMimeType.some(M=>(o==null?void 0:o.indexOf(M))!==-1):!0;let C=e.serverConfig.fileExt;h||(C=o?"."+o:e.serverConfig.fileExt);const x=e.allowCharset.includes(n)?n:e.allowCharset[0],v=r.toString(x),k=h?S.transformInnerCodeTempate(v):v,E=w.join(i.config.root,e.serverConfig.mockDir,e.serverConfig.scanOutput,p+C);s.writeMockFile(E,k,{encoding:x})})}})}}catch(t){s.logger.error(t)}}exports.useProxyRes=O;
