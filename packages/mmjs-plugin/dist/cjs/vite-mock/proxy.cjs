"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const o=require("./utils.cjs"),p=require("./options.cjs"),m=require("node:path"),k=require("./parse.cjs"),C=require("node:fs");function v(i){var a;const s=((a=i.config.server)==null?void 0:a.proxy)??{};for(let h in s)try{const n=s[h];if(typeof n!="object")continue;const u=n.configure;n.configure=(f,d)=>{f.on("proxyRes",(r,T,B)=>{var l;typeof u=="function"&&u(f,d);const g=m.join(o.safeUrlToFilename(d.target??""),((l=T._parsedUrl)==null?void 0:l.pathname)??"");if(g){const S=r.headers["content-type"],{encoding:y,isInnerTempType:b,mimeType:q,fileExt:w}=o.useContentType(S),c=m.join(i.config.root,p.serverConfig.mockDir,p.serverConfig.scanOutput,g+w);if(b){const e=[];r.on("data",t=>{e.push(t)}),r.on("end",()=>{const P=Buffer.concat(e).toString(y),j=k.transformInnerCodeTempate(P,q);o.writeMockFile(c,j,{encoding:y})})}else{const e=C.createWriteStream(c);e.on("error",t=>{o.logger.error(t),e.destroy()}),e.on("close",()=>{o.logger.success(`âœ… writeStream End ${o.colorize(c,"underline")}`),e.destroyed||e.destroy()}),r.on("data",t=>{e.write(t)}),r.on("end",()=>{e.end()})}}})}}catch(n){o.logger.error(n)}}exports.useProxyRes=v;
