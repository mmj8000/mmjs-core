"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const a=require("./utils.cjs"),e=require("./options.cjs"),u=require("node:fs"),q=require("node:path"),k=require("mime-types"),B=require("./parse.cjs");function F(r){var i;const t=((i=r.config.server)==null?void 0:i.proxy)??{};for(let s in t)try{const o=t[s];if(typeof o!="object")continue;const l=o.configure;o.configure=(g,M)=>{g.on("proxyRes",(m,b,P)=>{var d;typeof l=="function"&&l(g,M);const h=(d=b._parsedUrl)==null?void 0:d.pathname;if(h){const y=[];m.on("data",f=>{y.push(f)}),m.on("end",()=>{var S;const f=Buffer.concat(y),p=P.getHeaders()["content-type"];let c=k.charset(p)||e.allowCharset[0];c=c.toLocaleLowerCase();const n=k.extension(p)||e.serverConfig.fileExt.slice(1),C=(S=e.serverConfig._templateMimeType)!=null&&S.length?e.serverConfig._templateMimeType.some(j=>(n==null?void 0:n.indexOf(j))!==-1):!0;let x=e.serverConfig.fileExt;C||(x=n?"."+n:e.serverConfig.fileExt);const v=e.allowCharset.includes(c)?c:e.allowCharset[0],w=f.toString(v),E=C?B.transformInnerCodeTempate(w):w,_=q.join(r.config.root,e.serverConfig.mockDir,e.serverConfig.scanOutput,h+x);O(_,E,{encoding:v})})}})}}catch(o){a.logger.error(o)}}function L(r){try{const t=q.dirname(r);u.existsSync(t)||u.mkdirSync(t,{recursive:!0})}catch(t){a.logger.error(t)}}function O(r,t,i){L(r),u.writeFile(r,t,i,s=>{s?a.logger.wran(s):a.logger.success(`ðŸ’§ Save File Successify ${r}`)})}exports.useProxyRes=F;
