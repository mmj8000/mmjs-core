"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const i=require("./utils.cjs"),e=require("./options.cjs"),T=require("node:path"),b=require("mime-types"),S=require("./parse.cjs");function O(c){var l;const a=((l=c.config.server)==null?void 0:l.proxy)??{};for(let q in a)try{const o=a[q];if(typeof o!="object")continue;const f=o.configure;o.configure=(u,g)=>{u.on("proxyRes",(p,P,j)=>{var h;typeof f=="function"&&f(u,g);const y=T.join(i.safeUrlToFilename(g.target??""),((h=P._parsedUrl)==null?void 0:h.pathname)??"");if(y){const m=[];p.on("data",r=>{m.push(r)}),p.on("end",()=>{var w;const r=Buffer.concat(m),d=j.getHeaders()["content-type"];let n=b.charset(d)||e.allowCharset[0];n=n.toLocaleLowerCase();const t=b.extension(d)||e.serverConfig.fileExt.slice(1),C=(w=e.serverConfig.templateMimeType)!=null&&w.length?e.serverConfig.templateMimeType.some(M=>(t==null?void 0:t.indexOf(M))!==-1):!0;let x=e.serverConfig.fileExt,s=e.allowCharset.includes(n)?n:e.allowCharset[0];C?s=e.allowCharset[0]:x=t?"."+t:e.serverConfig.fileExt;const v=r.toString(s),k=C?S.transformInnerCodeTempate(v,t):v,E=T.join(c.config.root,e.serverConfig.mockDir,e.serverConfig.scanOutput,y+x);i.writeMockFile(E,k,{encoding:s})})}})}}catch(o){i.logger.error(o)}}exports.useProxyRes=O;
