"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const o=require("./utils.cjs"),h=require("./options.cjs"),S=require("node:path"),C=require("./parse.cjs"),v=require("node:fs");function B(i){var a;const c=((a=i.config.server)==null?void 0:a.proxy)??{};for(let T in c)try{const n=c[T];if(typeof n!="object")continue;const u=n.configure;n.configure=(f,d)=>{f.on("proxyRes",(r,y,M)=>{var g;typeof u=="function"&&u(f,d);const l=S.join(o.safeUrlToFilename(d.target??""),((g=y._parsedUrl)==null?void 0:g.pathname)??"");if(l){const b=r.headers["content-type"],{encoding:p,isInnerTempType:q,mimeType:w,fileExt:k}=o.useContentType(b),s=S.join(i.config.root,h.serverConfig.mockDir,h.serverConfig.scanOutput,l+k);if(q){const e=[];r.on("data",t=>{e.push(t)}),r.on("end",async()=>{var m;const P=Buffer.concat(e).toString(p),j=await C.transformInnerCodeTempate(P,w,{query:((m=y._parsedUrl)==null?void 0:m.query)??null,filePath:s});o.writeMockFile(s,j,{encoding:p})})}else{o.existsSyncByMkdir(s);const e=v.createWriteStream(s);e.on("error",t=>{o.logger.error(t),e.destroy()}),e.on("close",()=>{o.logger.success(`âœ… writeStream End ${o.colorize(s,"underline")}`),e.destroyed||e.destroy()}),r.on("data",t=>{e.write(t)}),r.on("end",()=>{e.end()})}}})}}catch(n){o.logger.error(n)}}exports.useProxyRes=B;
