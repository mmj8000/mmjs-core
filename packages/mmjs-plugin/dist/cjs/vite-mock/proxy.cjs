"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const t=require("./utils.cjs"),b=require("./options.cjs"),q=require("node:path"),C=require("./parse.cjs"),_=require("node:fs"),B=require("node:zlib");function E(o){var r;const u=((r=o.config.server)==null?void 0:r.proxy)??{};for(let d in u)try{const s=u[d];if(typeof s!="object")continue;const a=s.configure;s.configure=(f,l)=>{f.on("proxyRes",(i,p,O)=>{var y;typeof a=="function"&&a(f,l);const g=q.join(t.safeUrlToFilename(l.target??""),((y=p._parsedUrl)==null?void 0:y.pathname)??"");if(g){const w=i.headers["content-type"],{encoding:m,isInnerTempType:k,mimeType:z,fileExt:P}=t.useContentType(w),c=q.join(o.config.root,b.serverConfig.mockDir,b.serverConfig.scanOutput,g+P);if(k){const e=[];i.on("data",n=>{e.push(n)}),i.on("end",async()=>{var h;let n="";const j=i.headers["content-encoding"]==="gzip",S=Buffer.concat(e);if(j)try{n=B.gunzipSync(S).toString("utf-8")}catch(T){t.logger.error("解压失败"+T)}else n=S.toString(m);const v=await C.transformInnerCodeTempate(n,z,{query:((h=p._parsedUrl)==null?void 0:h.query)??null,filePath:c});t.writeMockFile(c,v,{encoding:m})})}else{t.existsSyncByMkdir(c);const e=_.createWriteStream(c);e.on("error",n=>{t.logger.error(n),e.destroy()}),e.on("close",()=>{t.logger.success(`✅ writeStream End ${t.colorize(c,"underline")}`),e.destroyed||e.destroy()}),i.on("data",n=>{e.write(n)}),i.on("end",()=>{e.end()})}}})}}catch(s){t.logger.error(s)}}function M(o){Reflect.set(o,"send",function(...u){if(!o.writableEnded){const[r,...d]=u;return o.end(typeof r!="function"?JSON.stringify(r):r,...d),o}return o})}exports.useProxyRes=E;exports.useResponseAppend=M;
