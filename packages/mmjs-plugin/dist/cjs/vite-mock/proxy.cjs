"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const o=require("./utils.cjs"),p=require("./options.cjs"),m=require("node:path"),j=require("./parse.cjs"),C=require("node:fs");function v(s){var a;const c=((a=s.config.server)==null?void 0:a.proxy)??{};for(let h in c)try{const n=c[h];if(typeof n!="object")continue;const u=n.configure;n.configure=(f,d)=>{f.on("proxyRes",(r,S,B)=>{var g;typeof u=="function"&&u(f,d);const y=m.join(o.safeUrlToFilename(d.target??""),((g=S._parsedUrl)==null?void 0:g.pathname)??"");if(y){const T=r.headers["content-type"],{encoding:l,isInnerTempType:b,mimeType:k,fileExt:q}=o.useContentType(T),i=m.join(s.config.root,p.serverConfig.mockDir,p.serverConfig.scanOutput,y+q);if(b){const e=[];r.on("data",t=>{e.push(t)}),r.on("end",()=>{const w=Buffer.concat(e).toString(l),P=j.transformInnerCodeTempate(w,k);o.writeMockFile(i,P,{encoding:l})})}else{o.existsSyncByMkdir(i);const e=C.createWriteStream(i);e.on("error",t=>{o.logger.error(t),e.destroy()}),e.on("close",()=>{o.logger.success(`âœ… writeStream End ${o.colorize(i,"underline")}`),e.destroyed||e.destroy()}),r.on("data",t=>{e.write(t)}),r.on("end",()=>{e.end()})}}})}}catch(n){o.logger.error(n)}}exports.useProxyRes=v;
