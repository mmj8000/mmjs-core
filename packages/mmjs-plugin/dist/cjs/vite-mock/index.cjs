"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const h=require("./parse.cjs"),y=require("node:path"),t=require("./utils.cjs"),x=require("node:url"),C=require("node:fs"),N=require("./proxy.cjs"),s=require("./options.cjs"),O=require("mime-types"),E=["no such file","Cannot find module"],k="Mock Not enabled";function F(w){const{scan:S,apiPrefix:v,forceMock:P,mockDir:j,timeout:M,fileExt:l}=Object.assign(s.serverConfig,w??{});return s.updateLogLevelState(),{name:"vite:mmjs:mock",apply:"serve",enforce:"post",configureServer(c){const f=c.config.root;s.serverConfig.root=f;const b=y.join(c.config.root,"package.json"),q=JSON.parse(C.readFileSync(b,"utf-8"));if(s.serverConfig._esm=q.type==="module",S)return t.logger.info("‚è≥ Scan Watching..."),N.useProxyRes(c);c.middlewares.use(v,async(n,a,d)=>{var g,p;let r="",m="";try{let e=function(){a.setHeader("Content-Type",O.contentType(r)),t.logger.success(`‚úÖ Mock Successify ${t.colorize(r,"underline")}`),setTimeout(()=>{a.end(JSON.stringify(i))},M)};if(n.headers.referer&&(m=new URL((g=n.headers)==null?void 0:g.referer).searchParams.get("remote")??""),m!=="mock"&&!P)return t.logger.info("üîí Browser URL not found mcok Keyword"),d();h.useParseQueryParams(n),await h.useParseBody(n);const u=((p=n._parsedUrl)==null?void 0:p.pathname)??"";n.headers["x-custom-request-header"]="vite-plugin-mmjs-mock",r=y.join(f,j,u+l);let o;if(s.serverConfig._esm?o=await import(x.pathToFileURL(r).href+"?t="+Date.now()):(require.cache&&delete require.cache[r],o=await require(r)),l===".json"&&o){e();return}if(!(o!=null&&o.enabled))throw new Error(k);let i=o.mock(n,a);i instanceof Promise&&(i=await i),i!==void 0&&e()}catch(e){(e==null?void 0:e.message.indexOf(k))!==-1?t.logger.info(`üîí Mock Not Enabled! ${t.colorize(r,"underline")}`):E.some(u=>{var o;return((o=e==null?void 0:e.message)==null?void 0:o.indexOf(u))!==-1})?t.logger.wran(`‚ùå File Not Found! ${t.colorize(r,"underline")}`):console.error(e),d()}})}}}exports.createMockServer=F;
