"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const x=require("./parse.cjs"),p=require("node:path"),e=require("./utils.cjs"),$=require("node:url"),v=require("node:fs"),J=require("./proxy.cjs"),i=require("./options.cjs"),U=require("./ndos.cjs"),q=["no such file","Cannot find module"],T="Mock Not enabled",y=b=>(Object.assign(i.serverConfig,i._initServerConfig,b??{}),i.updateLogLevelState(),{name:"vite:mmjs:mock",apply:"serve",enforce:"post",config(s,k){const{scan:w,mockDir:P}=i.serverConfig;if(w&&k.command==="serve")return{server:{watch:{ignored:[`**/${P}/**`]}}}},configureServer(s){const{scan:k,watchDynamicFile:w,apiPrefix:P,forceMock:D,mockDir:u,timeout:L}=i.serverConfig,f=s.config.root;i.serverConfig.root=f;const N=p.join(s.config.root,"package.json"),O=JSON.parse(v.readFileSync(N,"utf-8"));if(i.serverConfig._esm=O.type==="module",k)return e.logger.info("‚è≥ Scan Watching..."),J.useProxyRes(s);const C=p.join(f,u);if(w){s.watcher.off(u,l);const o=s.watcher.add(C);o.on("add",l),o.on("unlink",l),o.on("unlinkDir",l)}l();async function l(){try{const o=await U.enhancedFindFiles(C,{recursive:!0,exclude:/node_modules|\.git/});y.__dyMatchPaths=o}catch(o){e.logger.error(o)}}s.middlewares.use(P,async(o,d,g)=>{var M,_;let t="",F="";try{let r=function(n,a=e.getContentTypeByPath(t)){a&&d.setHeader("Content-Type",a),e.logger.success(`‚úÖ Mock Successify ${e.colorize(t,"underline")}`),setTimeout(()=>{d.end(JSON.stringify(n))},L)};if(o.headers.referer&&(F=new URL((M=o.headers)==null?void 0:M.referer).searchParams.get("remote")??""),F!=="mock"&&!D)return e.logger.info("üîí Browser URL not found mcok Keyword"),g();const S=o.headers[e.getHeaderMimeTypeKey(o)],{encoding:m,fileExt:j}=e.useContentType(S),E=((_=o._parsedUrl)==null?void 0:_.pathname)??"";o.headers["x-custom-request-header"]="vite-plugin-mmjs-mock",t=p.join(f,u,E+j);let c;if(!i.allowExt.includes(j)){const n=v.createReadStream(t),a=e.getContentTypeByPath(t);a&&d.setHeader("Content-Type",a),n.pipe(d),n.on("error",R=>{e.logger.error(R),n.destroy(),g()}),n.on("end",()=>{e.logger.success(`‚úÖ ReadStream End ${e.colorize(t,"underline")}`)}),n.on("close",()=>{n.destroyed||n.destroy()});return}if(!e.fileExists(t)){const n=p.join(f,u,E);t=e.findMatchingTemplatePath(y.__dyMatchPaths,n)||t}if(t.endsWith(".json"))try{const n=v.readFileSync(t,{encoding:m});return r(JSON.parse(n))}catch(n){return e.logger.wran(`${n}; ${t}`),g()}if(i.serverConfig._esm?c=await import($.pathToFileURL(t).href+"?t="+Date.now()):(require.cache&&delete require.cache[t],c=await require(t)),!(c!=null&&c.enabled))throw new Error(T);x.useParseQueryParams(o),x.useParseBody(o);let h=c.mock(o,d);h instanceof Promise&&(h=await h),r(h,"application/json")}catch(r){(r==null?void 0:r.message.indexOf(T))!==-1?e.logger.info(`üîí Mock Not Enabled! ${e.colorize(t,"underline")}`):q.some(S=>{var m;return((m=r==null?void 0:r.message)==null?void 0:m.indexOf(S))!==-1})?e.logger.wran(`‚ùå File Not Found! ${e.colorize(t,"underline")}`):console.error(r),g()}})}});y.__dyMatchPaths=[];exports.createMockServer=y;
