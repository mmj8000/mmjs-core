"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const F=require("./parse.cjs"),y=require("node:path"),e=require("./utils.cjs"),M=require("node:fs"),_=require("./proxy.cjs"),s=require("./options.cjs"),T=require("./ndos.cjs"),C=a=>(Object.assign(s.serverConfig,s._initServerConfig,a??{}),s.updateLogLevelState(),{name:"vite:mmjs:mock",apply:"serve",enforce:"post",config(t,c){const{scan:u,mockDir:l}=s.serverConfig;if(u&&c.command==="serve")return{server:{watch:{ignored:[`**/${l}/**`]}}}},configureServer(t){const{scan:c,watchDynamicFile:u,apiPrefix:l,mockDir:m}=s.serverConfig,k=t.config.root;s.serverConfig.root=k;const E=y.join(t.config.root,"package.json"),w=JSON.parse(M.readFileSync(E,"utf-8"));if(s.serverConfig._esm=w.type==="module",c)return e.logger.info("‚è≥ Scan Watching..."),_.useProxyRes(t);const o=y.join(k,m);if(u){t.watcher.off(m,d);const i=t.watcher.add(o);i.on("add",d),i.on("unlink",d),i.on("unlinkDir",d)}d();async function d(){try{const i=await T.enhancedFindFiles(o,{recursive:!0,exclude:/node_modules|\.git/});C.__dyMatchPaths=i}catch(i){e.logger.error(i)}}let g=[];if(Array.isArray(l))g.push(...l);else if(l)g.push(l);else{e.logger.error("API Prefix Non-standard");return}g.forEach(i=>{t.middlewares.use(i,b)})}});C.__dyMatchPaths=[];async function b(a,t,c){var g,i;const{root:u,forceMock:l,mockDir:m,timeout:k,downloadExtensions:E,allowOrigin:w}=s.serverConfig;let o="",d="";try{let r=function(n,h=e.getContentTypeByPath(o)){if(t.writableEnded)return e.logger.success(`‚úÖ Mock Successify ${e.colorize(o,"underline")}`);try{h&&t.setHeader("Content-Type",h),setTimeout(()=>{t.end(JSON.stringify(n)),e.logger.success(`‚úÖ Mock Successify ${e.colorize(o,"underline")}`)},k)}catch(f){e.logger.error(f)}};if(a.headers.referer&&(d=new URL((g=a.headers)==null?void 0:g.referer).searchParams.get("remote")??""),d!=="mock"&&!l)return e.logger.info("üîí Browser URL not found mcok Keyword"),c();const v=a.headers[e.getHeaderMimeTypeKey(a)],{encoding:S,fileExt:x}=e.useContentType(v),j=((i=a._parsedUrl)==null?void 0:i.pathname)??"";a.headers["x-custom-request-header"]="vite-plugin-mmjs-mock",t.setHeader("x-custom-response-header","vite-plugin-mmjs-mock"),t.setHeader("Access-Control-Allow-Origin",w),t.setHeader("Access-Control-Allow-Headers",w),o=y.join(u,m,j+x);let p;if(!s.allowExt.includes(x)){const n=M.createReadStream(o),h=e.getContentTypeByPath(o);if(t.setHeader("Content-Type",h||"application/octet-stream"),E.includes(x)){const f=y.basename(o);t.setHeader("Content-Disposition",`attachment; filename="${f}"`),t.setHeader("download-filename",f)}n.pipe(t),n.on("error",f=>{e.logger.error(f),n.destroy(),c()}),n.on("end",()=>{e.logger.success(`‚úÖ ReadStream End ${e.colorize(o,"underline")}`)}),n.on("close",()=>{n.destroyed||n.destroy()});return}if(!e.fileExists(o)){const n=y.join(u,m,j);o=e.findMatchingTemplatePath(C.__dyMatchPaths,n)||o}if(o.endsWith(".json"))try{const n=M.readFileSync(o,{encoding:S});return r(JSON.parse(n))}catch(n){return e.logger.wran(`${n}; ${o}`),c()}if(p=await e.dynamicImport(o),!(p!=null&&p.enabled))throw new Error(s.mockNoEnabledStr);F.useParseQueryParams(a),F.useParseBody(a),_.useResponseAppend(t);let P=p.mock(a,t);P instanceof Promise&&(P=await P),r(P,"application/json")}catch(r){(r==null?void 0:r.message.indexOf(s.mockNoEnabledStr))!==-1?e.logger.info(`üîí Mock Not Enabled! ${e.colorize(o,"underline")}`):s.notFileErrMsg.some(v=>{var S;return((S=r==null?void 0:r.message)==null?void 0:S.indexOf(v))!==-1})?e.logger.wran(`‚ùå File Not Found! ${e.colorize(o,"underline")}`):console.error(e.uniBeforeStrLog(),(r==null?void 0:r.message)||r,e.colorize(o,"underline")),c()}}exports.createMockServer=C;
