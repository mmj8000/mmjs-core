"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const j=require("./parse.cjs"),y=require("node:path"),e=require("./utils.cjs"),C=require("node:fs"),F=require("./proxy.cjs"),i=require("./options.cjs"),_=require("./ndos.cjs"),P=s=>(Object.assign(i.serverConfig,i._initServerConfig,s??{}),i.updateLogLevelState(),{name:"vite:mmjs:mock",apply:"serve",enforce:"post",config(r,a){const{scan:d,mockDir:c}=i.serverConfig;if(d&&a.command==="serve")return{server:{watch:{ignored:[`**/${c}/**`]}}}},configureServer(r){const{scan:a,watchDynamicFile:d,apiPrefix:c,mockDir:m}=i.serverConfig,k=r.config.root;i.serverConfig.root=k;const E=y.join(r.config.root,"package.json"),t=JSON.parse(C.readFileSync(E,"utf-8"));if(i.serverConfig._esm=t.type==="module",a)return e.logger.info("‚è≥ Scan Watching..."),F.useProxyRes(r);const g=y.join(k,m);if(d){r.watcher.off(m,l);const o=r.watcher.add(g);o.on("add",l),o.on("unlink",l),o.on("unlinkDir",l)}l();async function l(){try{const o=await _.enhancedFindFiles(g,{recursive:!0,exclude:/node_modules|\.git/});P.__dyMatchPaths=o}catch(o){e.logger.error(o)}}let u=[];if(Array.isArray(c))u.push(...c);else if(c)u.push(c);else{e.logger.error("API Prefix Non-standard");return}u.forEach(o=>{r.middlewares.use(o,T)})}});P.__dyMatchPaths=[];async function T(s,r,a){var l,u;const{root:d,forceMock:c,mockDir:m,timeout:k,downloadExtensions:E}=i.serverConfig;let t="",g="";try{let o=function(n,p=e.getContentTypeByPath(t)){if(r.writableEnded)return e.logger.success(`‚úÖ Mock Successify ${e.colorize(t,"underline")}`);try{p&&r.setHeader("Content-Type",p),setTimeout(()=>{r.end(JSON.stringify(n)),e.logger.success(`‚úÖ Mock Successify ${e.colorize(t,"underline")}`)},k)}catch(f){e.logger.error(f)}};if(s.headers.referer&&(g=new URL((l=s.headers)==null?void 0:l.referer).searchParams.get("remote")??""),g!=="mock"&&!c)return e.logger.info("üîí Browser URL not found mcok Keyword"),a();const v=s.headers[e.getHeaderMimeTypeKey(s)],{encoding:w,fileExt:x}=e.useContentType(v),M=((u=s._parsedUrl)==null?void 0:u.pathname)??"";s.headers["x-custom-request-header"]="vite-plugin-mmjs-mock",r.setHeader("x-custom-response-header","vite-plugin-mmjs-mock"),t=y.join(d,m,M+x);let h;if(!i.allowExt.includes(x)){const n=C.createReadStream(t),p=e.getContentTypeByPath(t);if(r.setHeader("Content-Type",p||"application/octet-stream"),E.includes(x)){const f=y.basename(t);r.setHeader("Content-Disposition",`attachment; filename="${f}"`),r.setHeader("download-filename",f)}n.pipe(r),n.on("error",f=>{e.logger.error(f),n.destroy(),a()}),n.on("end",()=>{e.logger.success(`‚úÖ ReadStream End ${e.colorize(t,"underline")}`)}),n.on("close",()=>{n.destroyed||n.destroy()});return}if(!e.fileExists(t)){const n=y.join(d,m,M);t=e.findMatchingTemplatePath(P.__dyMatchPaths,n)||t}if(t.endsWith(".json"))try{const n=C.readFileSync(t,{encoding:w});return o(JSON.parse(n))}catch(n){return e.logger.wran(`${n}; ${t}`),a()}if(h=await e.dynamicImport(t),!(h!=null&&h.enabled))throw new Error(i.mockNoEnabledStr);j.useParseQueryParams(s),j.useParseBody(s);let S=h.mock(s,r);S instanceof Promise&&(S=await S),o(S,"application/json")}catch(o){(o==null?void 0:o.message.indexOf(i.mockNoEnabledStr))!==-1?e.logger.info(`üîí Mock Not Enabled! ${e.colorize(t,"underline")}`):i.notFileErrMsg.some(v=>{var w;return((w=o==null?void 0:o.message)==null?void 0:w.indexOf(v))!==-1})?e.logger.wran(`‚ùå File Not Found! ${e.colorize(t,"underline")}`):console.error(e.uniBeforeStrLog(),(o==null?void 0:o.message)||o,e.colorize(t,"underline")),a()}}exports.createMockServer=P;
