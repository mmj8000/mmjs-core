"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const d=require("./parse.cjs"),S=require("node:path"),n=require("./utils.cjs"),$=require("node:url"),v=require("node:fs"),q=require("./proxy.cjs"),c=require("./options.cjs"),x=require("mime-types"),E=["no such file","Cannot find module"],j="Mock Not enabled";function L(P){const{scan:m,apiPrefix:M,forceMock:b,mockDir:p,timeout:C,fileExt:h}=Object.assign(c.serverConfig,P??{});return c.updateLogLevelState(),{name:"vite:mmjs:mock",apply:"serve",enforce:"post",config(i,a){if(m&&a.command==="serve")return{server:{watch:{ignored:[`**/${p}/**`]}}}},configureServer(i){const a=i.config.root;c.serverConfig.root=a;const N=S.join(i.config.root,"package.json"),O=JSON.parse(v.readFileSync(N,"utf-8"));if(c.serverConfig._esm=O.type==="module",m)return n.logger.info("‚è≥ Scan Watching..."),q.useProxyRes(i);i.middlewares.use(M,async(t,l,f)=>{var k,w;let e="",y="";try{let o=function(s,F=x.contentType(e)){l.setHeader("Content-Type",F),n.logger.success(`‚úÖ Mock Successify ${n.colorize(e,"underline")}`),setTimeout(()=>{l.end(JSON.stringify(s))},C)};if(t.headers.referer&&(y=new URL((k=t.headers)==null?void 0:k.referer).searchParams.get("remote")??""),y!=="mock"&&!b)return n.logger.info("üîí Browser URL not found mcok Keyword"),f();const g=((w=t._parsedUrl)==null?void 0:w.pathname)??"";t.headers["x-custom-request-header"]="vite-plugin-mmjs-mock",e=S.join(a,p,g+h);let r;if(h===".json")try{const s=v.readFileSync(e,{encoding:d.getCharset(t)});return o(JSON.parse(s))}catch(s){return n.logger.wran(`${s}; ${e}`),f()}if(c.serverConfig._esm?r=await import($.pathToFileURL(e).href+"?t="+Date.now()):(require.cache&&delete require.cache[e],r=await require(e)),!(r!=null&&r.enabled))throw new Error(j);d.useParseQueryParams(t),d.useParseBody(t);let u=r.mock(t,l);u instanceof Promise&&(u=await u),o(u,"application/json")}catch(o){(o==null?void 0:o.message.indexOf(j))!==-1?n.logger.info(`üîí Mock Not Enabled! ${n.colorize(e,"underline")}`):E.some(g=>{var r;return((r=o==null?void 0:o.message)==null?void 0:r.indexOf(g))!==-1})?n.logger.wran(`‚ùå File Not Found! ${n.colorize(e,"underline")}`):console.error(o),f()}})}}}exports.createMockServer=L;
