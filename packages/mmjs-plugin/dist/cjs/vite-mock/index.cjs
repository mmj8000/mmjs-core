"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const d=require("./parse.cjs"),m=require("node:path"),t=require("./utils.cjs"),L=require("node:url"),N=require("node:fs"),F=["no such file","Cannot find module"],g="Mock Not enabled";function O(p){const{apiPrefix:h="/mock",forceMock:k=!1,mockDir:w="__mock__",fileSuffix:y=".js",timeout:S=500,logLevel:i=["info","succes","wran"]}=p??{};return{name:"vite:mmjs:mock",apply:"serve",enforce:"post",configureServer(c){const P=i.includes("wran"),j=i.includes("info"),M=i.includes("succes"),v=c.config.root,_=m.join(c.config.root,"package.json"),b=JSON.parse(N.readFileSync(_,"utf-8"));c.middlewares.use(h,async(n,a,l)=>{var f;let s="",u="";try{if(n.headers.referer&&(u=new URL((f=n.headers)==null?void 0:f.referer).searchParams.get("remote")??""),u!=="mock"&&!k)return l();d.useParseQueryParams(n),await d.useParseBody(n);const e=n._parsedUrl.pathname??"";n.headers["x-custom-request-header"]="vite-plugin-mmjs-mock",s=m.join(v,w,e+y);let o;if(b.type==="module"?o=await import(L.pathToFileURL(s).href+"?t="+Date.now()):(require.cache&&delete require.cache[s],o=await require(s)),!(o!=null&&o.enabled))throw new Error(g);a.setHeader("Content-Type","application/json");let r=o.mock(n,a);r instanceof Promise&&(r=await r),r!==void 0&&(M&&t.logger.success(`üöÄ Mock Successify ${t.colorize(s,"underline")}`),setTimeout(()=>{a.end(JSON.stringify(r))},S))}catch(e){(e==null?void 0:e.message.indexOf(g))!==-1?j&&t.logger.info(`‚ùì Mock Not Enabled! ${t.colorize(s,"underline")}`):F.some(o=>{var r;return((r=e==null?void 0:e.message)==null?void 0:r.indexOf(o))!==-1})?P&&t.logger.wran(`‚ùå File Not Found! ${t.colorize(s,"underline")}`):console.error(e),l()}})}}}exports.createMockServer=O;
