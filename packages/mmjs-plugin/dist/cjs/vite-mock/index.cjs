"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const T=require("./parse.cjs"),y=require("node:path"),e=require("./utils.cjs"),B=require("node:url"),C=require("node:fs"),J=require("./proxy.cjs"),i=require("./options.cjs"),U=require("./ndos.cjs"),q=["no such file","Cannot find module"],N="Mock Not enabled",k=L=>(Object.assign(i.serverConfig,i._initServerConfig,L??{}),i.updateLogLevelState(),{name:"vite:mmjs:mock",apply:"serve",enforce:"post",config(s,w){const{scan:P,mockDir:a}=i.serverConfig;if(P&&w.command==="serve")return{server:{watch:{ignored:[`**/${a}/**`]}}}},configureServer(s){const{scan:w,watchDynamicFile:P,apiPrefix:a,forceMock:b,mockDir:f,timeout:D}=i.serverConfig,g=s.config.root;i.serverConfig.root=g;const O=y.join(s.config.root,"package.json"),R=JSON.parse(C.readFileSync(O,"utf-8"));if(i.serverConfig._esm=R.type==="module",w)return e.logger.info("‚è≥ Scan Watching..."),J.useProxyRes(s);const M=y.join(g,f);if(P){s.watcher.off(f,d);const o=s.watcher.add(M);o.on("add",d),o.on("unlink",d),o.on("unlinkDir",d)}d();async function d(){try{const o=await U.enhancedFindFiles(M,{recursive:!0,exclude:/node_modules|\.git/});k.__dyMatchPaths=o}catch(o){e.logger.error(o)}}let S=[];if(Array.isArray(a))S.push(...a);else if(a)S.push(a);else{e.logger.error("API Prefix Non-standard");return}S.forEach(o=>{s.middlewares.use(o,$)});async function $(o,u,m){var F,_;let r="",E="";try{let n=function(t,l=e.getContentTypeByPath(r)){l&&u.setHeader("Content-Type",l),e.logger.success(`‚úÖ Mock Successify ${e.colorize(r,"underline")}`),setTimeout(()=>{u.end(JSON.stringify(t))},D)};if(o.headers.referer&&(E=new URL((F=o.headers)==null?void 0:F.referer).searchParams.get("remote")??""),E!=="mock"&&!b)return e.logger.info("üîí Browser URL not found mcok Keyword"),m();const v=o.headers[e.getHeaderMimeTypeKey(o)],{encoding:h,fileExt:j}=e.useContentType(v),x=((_=o._parsedUrl)==null?void 0:_.pathname)??"";o.headers["x-custom-request-header"]="vite-plugin-mmjs-mock",r=y.join(g,f,x+j);let c;if(!i.allowExt.includes(j)){const t=C.createReadStream(r),l=e.getContentTypeByPath(r);l&&u.setHeader("Content-Type",l),t.pipe(u),t.on("error",z=>{e.logger.error(z),t.destroy(),m()}),t.on("end",()=>{e.logger.success(`‚úÖ ReadStream End ${e.colorize(r,"underline")}`)}),t.on("close",()=>{t.destroyed||t.destroy()});return}if(!e.fileExists(r)){const t=y.join(g,f,x);r=e.findMatchingTemplatePath(k.__dyMatchPaths,t)||r}if(r.endsWith(".json"))try{const t=C.readFileSync(r,{encoding:h});return n(JSON.parse(t))}catch(t){return e.logger.wran(`${t}; ${r}`),m()}if(i.serverConfig._esm?c=await import(B.pathToFileURL(r).href+"?t="+Date.now()):(require.cache&&delete require.cache[r],c=await require(r)),!(c!=null&&c.enabled))throw new Error(N);T.useParseQueryParams(o),T.useParseBody(o);let p=c.mock(o,u);p instanceof Promise&&(p=await p),n(p,"application/json")}catch(n){(n==null?void 0:n.message.indexOf(N))!==-1?e.logger.info(`üîí Mock Not Enabled! ${e.colorize(r,"underline")}`):q.some(v=>{var h;return((h=n==null?void 0:n.message)==null?void 0:h.indexOf(v))!==-1})?e.logger.wran(`‚ùå File Not Found! ${e.colorize(r,"underline")}`):console.error(e.uniBeforeStrLog(),(n==null?void 0:n.message)||n),m()}}}});k.__dyMatchPaths=[];exports.createMockServer=k;
