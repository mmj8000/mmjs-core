"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const p=require("./parse.cjs"),h=require("node:path"),t=require("./utils.cjs"),x=require("node:url"),N=require("node:fs"),O=require("./proxy.cjs"),c=require("./options.cjs"),C=require("mime-types"),E=["no such file","Cannot find module"],y="Mock Not enabled";function F(k){const{scan:w,apiPrefix:S,forceMock:P,mockDir:v,timeout:j,fileExt:l}=Object.assign(c.serverConfig,k??{});return c.updateLogLevelState(),{name:"vite:mmjs:mock",apply:"serve",enforce:"post",configureServer(s){const M=s.config.root,b=h.join(s.config.root,"package.json"),q=JSON.parse(N.readFileSync(b,"utf-8"));if(c.serverConfig._esm=q.type==="module",w)return t.logger.info("‚è≥ Scan Watching..."),O.useProxyRes(s);s.middlewares.use(S,async(n,a,f)=>{var m,g;let r="",d="";try{let e=function(){a.setHeader("Content-Type",C.contentType(r)),t.logger.success(`‚úÖ Mock Successify ${t.colorize(r,"underline")}`),setTimeout(()=>{a.end(JSON.stringify(i))},j)};if(n.headers.referer&&(d=new URL((m=n.headers)==null?void 0:m.referer).searchParams.get("remote")??""),d!=="mock"&&!P)return t.logger.info("üîí Browser URL not found mcok Keyword"),f();p.useParseQueryParams(n),await p.useParseBody(n);const u=((g=n._parsedUrl)==null?void 0:g.pathname)??"";n.headers["x-custom-request-header"]="vite-plugin-mmjs-mock",r=h.join(M,v,u+l);let o;if(c.serverConfig._esm?o=await import(x.pathToFileURL(r).href+"?t="+Date.now()):(require.cache&&delete require.cache[r],o=await require(r)),l===".json"&&o){e();return}if(!(o!=null&&o.enabled))throw new Error(y);let i=o.mock(n,a);i instanceof Promise&&(i=await i),i!==void 0&&e()}catch(e){(e==null?void 0:e.message.indexOf(y))!==-1?t.logger.info(`üîí Mock Not Enabled! ${t.colorize(r,"underline")}`):E.some(u=>{var o;return((o=e==null?void 0:e.message)==null?void 0:o.indexOf(u))!==-1})?t.logger.wran(`‚ùå File Not Found! ${t.colorize(r,"underline")}`):console.error(e),f()}})}}}exports.createMockServer=F;
