"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const x=require("./parse.cjs"),p=require("node:path"),e=require("./utils.cjs"),$=require("node:url"),v=require("node:fs"),q=require("./proxy.cjs"),i=require("./options.cjs"),J=require("./ndos.cjs"),U=["no such file","Cannot find module"],T="Mock Not enabled",y=b=>(Object.assign(i.serverConfig,i._initServerConfig,b??{}),i.updateLogLevelState(),{name:"vite:mmjs:mock",apply:"serve",enforce:"post",config(s,k){const{scan:w,mockDir:P}=i.serverConfig;if(w&&k.command==="serve")return{server:{watch:{ignored:[`**/${P}/**`]}}}},configureServer(s){const{scan:k,watchDynamicFile:w,apiPrefix:P,forceMock:D,mockDir:u,timeout:L}=i.serverConfig,f=s.config.root;i.serverConfig.root=f;const N=p.join(s.config.root,"package.json"),O=JSON.parse(v.readFileSync(N,"utf-8"));if(i.serverConfig._esm=O.type==="module",k)return e.logger.info("‚è≥ Scan Watching..."),q.useProxyRes(s);const C=p.join(f,u);if(w){s.watcher.off(u,l);const t=s.watcher.add(C);t.on("add",l),t.on("unlink",l),t.on("unlinkDir",l)}l();async function l(){try{const t=await J.enhancedFindFiles(C,{recursive:!0,exclude:/node_modules|\.git/});y.__dyMatchPaths=t}catch(t){e.logger.error(t)}}s.middlewares.use(P,async(t,d,g)=>{var _,j;let o="",F="";try{let r=function(n,a=e.getContentTypeByPath(o)){a&&d.setHeader("Content-Type",a),e.logger.success(`‚úÖ Mock Successify ${e.colorize(o,"underline")}`),setTimeout(()=>{d.end(JSON.stringify(n))},L)};if(t.headers.referer&&(F=new URL((_=t.headers)==null?void 0:_.referer).searchParams.get("remote")??""),F!=="mock"&&!D)return e.logger.info("üîí Browser URL not found mcok Keyword"),g();const S=t.headers["content-type"],{encoding:m,fileExt:E}=e.useContentType(S),M=((j=t._parsedUrl)==null?void 0:j.pathname)??"";t.headers["x-custom-request-header"]="vite-plugin-mmjs-mock",o=p.join(f,u,M+E);let c;if(!i.allowExt.includes(E)){const n=v.createReadStream(o),a=e.getContentTypeByPath(o);a&&d.setHeader("Content-Type",a),n.pipe(d),n.on("error",R=>{e.logger.error(R),n.destroy(),g()}),n.on("end",()=>{e.logger.success(`‚úÖ ReadStream End ${e.colorize(o,"underline")}`)}),n.on("close",()=>{n.destroyed||n.destroy()});return}if(!e.fileExists(o)){const n=p.join(f,u,M);o=e.findMatchingTemplatePath(y.__dyMatchPaths,n)||o}if(o.endsWith(".json"))try{const n=v.readFileSync(o,{encoding:m});return r(JSON.parse(n))}catch(n){return e.logger.wran(`${n}; ${o}`),g()}if(i.serverConfig._esm?c=await import($.pathToFileURL(o).href+"?t="+Date.now()):(require.cache&&delete require.cache[o],c=await require(o)),!(c!=null&&c.enabled))throw new Error(T);x.useParseQueryParams(t),x.useParseBody(t);let h=c.mock(t,d);h instanceof Promise&&(h=await h),r(h,"application/json")}catch(r){(r==null?void 0:r.message.indexOf(T))!==-1?e.logger.info(`üîí Mock Not Enabled! ${e.colorize(o,"underline")}`):U.some(S=>{var m;return((m=r==null?void 0:r.message)==null?void 0:m.indexOf(S))!==-1})?e.logger.wran(`‚ùå File Not Found! ${e.colorize(o,"underline")}`):console.error(r),g()}})}});y.__dyMatchPaths=[];exports.createMockServer=y;
