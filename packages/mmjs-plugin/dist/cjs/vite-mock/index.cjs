"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const E=require("./parse.cjs"),S=require("node:path"),e=require("./utils.cjs"),v=require("node:fs"),F=require("./proxy.cjs"),c=require("./options.cjs"),_=require("./ndos.cjs"),T=["no such file","Cannot find module"],j="Mock Not enabled",w=s=>(Object.assign(c.serverConfig,c._initServerConfig,s??{}),c.updateLogLevelState(),{name:"vite:mmjs:mock",apply:"serve",enforce:"post",config(t,a){const{scan:u,mockDir:l}=c.serverConfig;if(u&&a.command==="serve")return{server:{watch:{ignored:[`**/${l}/**`]}}}},configureServer(t){const{scan:a,watchDynamicFile:u,apiPrefix:l,mockDir:g}=c.serverConfig,y=t.config.root;c.serverConfig.root=y;const o=S.join(t.config.root,"package.json"),p=JSON.parse(v.readFileSync(o,"utf-8"));if(c.serverConfig._esm=p.type==="module",a)return e.logger.info("‚è≥ Scan Watching..."),F.useProxyRes(t);const m=S.join(y,g);if(u){t.watcher.off(g,d);const i=t.watcher.add(m);i.on("add",d),i.on("unlink",d),i.on("unlinkDir",d)}d();async function d(){try{const i=await _.enhancedFindFiles(m,{recursive:!0,exclude:/node_modules|\.git/});w.__dyMatchPaths=i}catch(i){e.logger.error(i)}}let n=[];if(Array.isArray(l))n.push(...l);else if(l)n.push(l);else{e.logger.error("API Prefix Non-standard");return}n.forEach(i=>{t.middlewares.use(i,N)})}});w.__dyMatchPaths=[];async function N(s,t,a){var m,d;const{root:u,forceMock:l,mockDir:g,timeout:y}=c.serverConfig;let o="",p="";try{let n=function(r,f=e.getContentTypeByPath(o)){f&&t.setHeader("Content-Type",f),e.logger.success(`‚úÖ Mock Successify ${e.colorize(o,"underline")}`),setTimeout(()=>{t.end(JSON.stringify(r))},y)};if(s.headers.referer&&(p=new URL((m=s.headers)==null?void 0:m.referer).searchParams.get("remote")??""),p!=="mock"&&!l)return e.logger.info("üîí Browser URL not found mcok Keyword"),a();const i=s.headers[e.getHeaderMimeTypeKey(s)],{encoding:k,fileExt:C}=e.useContentType(i),M=((d=s._parsedUrl)==null?void 0:d.pathname)??"";s.headers["x-custom-request-header"]="vite-plugin-mmjs-mock",o=S.join(u,g,M+C);let h;if(!c.allowExt.includes(C)){const r=v.createReadStream(o),f=e.getContentTypeByPath(o);f&&t.setHeader("Content-Type",f),r.pipe(t),r.on("error",x=>{e.logger.error(x),r.destroy(),a()}),r.on("end",()=>{e.logger.success(`‚úÖ ReadStream End ${e.colorize(o,"underline")}`)}),r.on("close",()=>{r.destroyed||r.destroy()});return}if(!e.fileExists(o)){const r=S.join(u,g,M);o=e.findMatchingTemplatePath(w.__dyMatchPaths,r)||o}if(o.endsWith(".json"))try{const r=v.readFileSync(o,{encoding:k});return n(JSON.parse(r))}catch(r){return e.logger.wran(`${r}; ${o}`),a()}if(h=await e.dynamicImport(o),!(h!=null&&h.enabled))throw new Error(j);E.useParseQueryParams(s),E.useParseBody(s);let P=h.mock(s,t);P instanceof Promise&&(P=await P),n(P,"application/json")}catch(n){(n==null?void 0:n.message.indexOf(j))!==-1?e.logger.info(`üîí Mock Not Enabled! ${e.colorize(o,"underline")}`):T.some(i=>{var k;return((k=n==null?void 0:n.message)==null?void 0:k.indexOf(i))!==-1})?e.logger.wran(`‚ùå File Not Found! ${e.colorize(o,"underline")}`):console.error(e.uniBeforeStrLog(),(n==null?void 0:n.message)||n,e.colorize(o,"underline")),a()}}exports.createMockServer=w;
