"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const k=require("./parse.cjs"),y=require("node:path"),n=require("./utils.cjs"),C=require("node:url"),N=require("node:fs"),O=require("./proxy.cjs"),c=require("./options.cjs"),E=require("mime-types"),F=["no such file","Cannot find module"],v="Mock Not enabled";function L(w){const{scan:f,apiPrefix:S,forceMock:P,mockDir:j,timeout:_,fileExt:d}=Object.assign(c.serverConfig,w??{});return c.updateLogLevelState(),{name:"vite:mmjs:mock",apply:"serve",enforce:"post",config(i,a){if(f&&a.command==="serve")return{server:{watch:{ignored:["**/__mock__/**"]}}}},configureServer(i){const a=i.config.root;c.serverConfig.root=a;const M=y.join(i.config.root,"package.json"),b=JSON.parse(N.readFileSync(M,"utf-8"));if(c.serverConfig._esm=b.type==="module",f)return n.logger.info("‚è≥ Scan Watching..."),O.useProxyRes(i);i.middlewares.use(S,async(t,u,m)=>{var p,h;let r="",g="";try{let o=function(q,x=E.contentType(r)){u.setHeader("Content-Type",x),n.logger.success(`‚úÖ Mock Successify ${n.colorize(r,"underline")}`),setTimeout(()=>{u.end(JSON.stringify(q))},_)};if(t.headers.referer&&(g=new URL((p=t.headers)==null?void 0:p.referer).searchParams.get("remote")??""),g!=="mock"&&!P)return n.logger.info("üîí Browser URL not found mcok Keyword"),m();k.useParseQueryParams(t),k.useParseBody(t);const l=((h=t._parsedUrl)==null?void 0:h.pathname)??"";t.headers["x-custom-request-header"]="vite-plugin-mmjs-mock",r=y.join(a,j,l+d);let e;if(c.serverConfig._esm?e=await import(C.pathToFileURL(r).href+"?t="+Date.now()):(require.cache&&delete require.cache[r],e=await require(r)),d===".json"&&e){o(e);return}if(!(e!=null&&e.enabled))throw new Error(v);let s=e.mock(t,u);s instanceof Promise&&(s=await s),s!==void 0&&o(s,"application/json")}catch(o){(o==null?void 0:o.message.indexOf(v))!==-1?n.logger.info(`üîí Mock Not Enabled! ${n.colorize(r,"underline")}`):F.some(l=>{var e;return((e=o==null?void 0:o.message)==null?void 0:e.indexOf(l))!==-1})?n.logger.wran(`‚ùå File Not Found! ${n.colorize(r,"underline")}`):console.error(o),m()}})}}}exports.createMockServer=L;
